<html>
<head>
</head>
<body>
<script>

/**
    Messaging system
*/
//  data = "data:" + myRequest.getResponseHeader('content-type') + ";base64," + window.btoa(myRequest.responseText);

var msgCallbacks = {}
var lastRefreshTime = 0;

function getMessages(f) {
        var myRequest = new XMLHttpRequest();

        myRequest.onreadystatechange = function() {
                if (myRequest.readyState == XMLHttpRequest.DONE && myRequest.status == 200) {
                    f(JSON.parse(myRequest.responseText));
                }
        };
        myRequest.open("GET", "http://localhost:8000/messages?since=" + lastRefreshTime, true);
        myRequest.send();
}

function postCandidate(type, info, f) {
        var myRequest = new XMLHttpRequest();

        myRequest.onreadystatechange = function() {
                if (myRequest.readyState == XMLHttpRequest.DONE && myRequest.status == 200) {
                    console.log("POST: ", myRequest.responseText);
                    f(JSON.parse(myRequest.responseText));
                }
        };
        myRequest.open("POST", "http://localhost:8000/messages", true);
        myRequest.send("d=" + encodeURIComponent(info));
}

function registerCallback(msgtype, callable) {
    if (msgtype in msgCallbacks) {
        msgCallbacks[msgtype].concat([callable]);
    } else {
        msgCallbacks[msgtype] = [callable];
    }
}

function dispatchMessage(type, data) {
    if (type in msgCallbacks)
        for (f in msgCallbacks[type]) {
            msgCallbacks[type][f](data);
        }
}

function startMesssageSystem() {
    setInterval(getMessages, 1000, function(data) {
        for (m in data) {
            if (data[m].c > lastRefreshTime) {
                lastRefreshTime = data[m].c;
                dispatchMessage(data[m].t, data[m].d);
            }
        }
    });
}

registerCallback("t1", function(message) {
    console.log("m: ", message, lastRefreshTime);
});

startMesssageSystem();

</script>
<!-- script>

/**
    P2P system
*/

var localPeerConnection = undefined;
var sendChannel = undefined;

//setInterval(function(){postCandidate("test", function(data) {
//    document.getElementById('list1').innerHTML += data + "<br/>";
//})}, 1000);

function rtcTest() {

        var iceServers = {
            iceServers: [{
            url: 'stun:adamian-desktop.isw.intel.com'
            }]
        };

        if (window.RTCPeerConnection != undefined )
                RPCObject =  window.RTCPeerConnection
        else if (window.mozRTCPeerConnection != undefined )
                RPCObject =  window.mozRTCPeerConnection
        else if (window.webkitRTCPeerConnection != undefined )
                RPCObject =  window.webkitRTCPeerConnection
        else throw "Error finding RPCObject";

        localPeerConnection = new RPCObject(iceServers, {optional: [{RtpDataChannels: true}]});

        localPeerConnection.onicecandidate = function(evt) {
            postCandidate(JSON.stringify({"ice":evt.candidate}));
        }

        localPeerConnection.onconnecting = function(evt) {
            console.log("2: !" , evt);
        }

        localPeerConnection.onopen = function(evt) {
            console.log("3: !" , evt);
        }

        localPeerConnection.ondatachannel = function(evt) {
            console.log("4: !" , evt);
        }

        localPeerConnection.oniceconnectionstatechange = function(evt) {
            console.log("5: !" , evt);
        }

        localPeerConnection.onnegotiationneeded = function(evt) {
            console.log("onnegotiationneded: !", evt);

            // TODO: search events, if not found, create offer
            getMessages(function(data){
              list = JSON.parse(data);
              found = false;
              for (i in list) {
                console.log(i);
                break;
              }

              if (found)
                localPeerConnection.setRemoteDescription(new RTCSessionDescription(i.sdp.sdp));
              else {
                localPeerConnection.createOffer(function(desc) {
                  console.log("desc ", desc)
                  localPeerConnection.setLocalDescription(desc);
                  postCandidate(JSON.stringify({"sdp":desc}), function(data){console.log(JSON.parse(data))});
                });
              }
            })
        }

        localPeerConnection.onsignalingstatechange = function(evt) {
            console.log("signalstatechange: !" , evt);
        }

        localPeerConnection.onaddstream = function(evt) {
            console.log("remoteaddedstream: !" , evt);
        }

        localPeerConnection.onremovestream = function(evt) {
            console.log("remoteremovedstream: !" , evt);
        }
        console.log(localPeerConnection);

        sendChannel = localPeerConnection.createDataChannel("data1", {});
        sendChannel.onopen = function(evt) {
            console.log("sC: 1" , evt);
        }


}

rtcTest();


//var lDataChannel = localPeerConnection.createDataChannel('dataSend', {reliable: false});

</script -->
<div id="list1"></div>
<!-- iframe id="iframe1"/-->
</body>
</html>
