<!DOCTYPE html>
<html>
<!-- vim: set tabstop=4 expandtab softab -->
<head><title>Vision</title>
</head>
<body>
<style>
.linedisplay {
    display: block-inline;
}

.selected {
    background-color: darkgrey;
}

</style>
<script src="js/jquery-2.0.3.min.js"></script>
<script src="js/angular.min.js"></script>
<script src="js/messaging.js"></script>
<script src="js/rtc.js"></script>
<script>


var lpc;

function callRemote(remoteId) {
    console.log("main: we call ", remoteId);
    lpc = rtcGetConnection( ROLE.CALLER, remoteId);

    // we want to register the candidates from the remote partner
    smsRegisterCallback("candidate", function receiveCandidates(sender, message) {
        msg = JSON.parse(message);
        var candidate = new RTCIceCandidate({sdpMLineIndex: msg.sdpMLineIndex, candidate: msg.candidate});
        lpc.addIceCandidate(candidate);
    }, remoteId);
}

function callWait() {
    console.log("main: we wait ");

    // we want to receive calls 
    smsRegisterCallback("sdp", function receiveSDP(sender, message) {

        msg = JSON.parse(message);
        console.log("got remote call from ", sender, msg);

        // TODO ? 
        lpc = rtcGetConnection( ROLE.RECEIVER, sender );

        lpc.setRemoteDescription(new RTCSessionDescription(msg),
            function () {
                console.log("success setting remote");
                lpc.createSDPResponse();
               }, console.log); // we got another peer's offer
       });
}

var currentlySelectedRemoteId;
var peerConns = {};

$(document).ready( function () {
    smsStartSystem();
    $('#localId').text(myId);

    // for each client already existing, we will createOffers and send them

    smsListClients(function updateDisplayClients(clients) {
        console.log(clients);
        wait = true;

        $('#idList').empty();
        for (i = 0; i < clients.length; i++) {
            
            childDiv = document.createElement("div");
            childDiv.text = clients[s].i;
            childDiv.classList.toggle("linedisplay", true);
            childDiv.addEventListener("click", function () {
                    $('#idList').child().toggleClass("selected", false);
                    this.classList.toggle("selected", true);
                    currentlySelectedRemoteId = this.text;
                }
            );
           
            $('#idList').append(childDiv);
        }
        // we will refresh the client list
        setTimeout(function() { smsListClients(updateDisplayClients); }, 1000);
    };

});

window.onbeforeunload = function () {
    console.log("almost dead");
    smsStopSystem();
};

</script>
<h4>Local Id</h4>
<p id="localId"></p>
<h4>Remote Id List</h4>
<p>
<div id="idList">
</div>
    <a href="Connect to selected " ></a>
</p>
<h4>Out</h4>
<p id="output"></p>

</body>
</html>
