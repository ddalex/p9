<!DOCTYPE html>
<html>
<!-- vim: set tabstop=4 expandtab softab -->
<head><title>Vision</title>
</head>
<body>
<script src="js/jquery-2.0.3.min.js"></script>
<script src="js/messaging.js"></script>
<script>

/**
    P2P single connection
*/

var ROLE = {
	CALLER : "caller",
	RECEIVER : "receive",
	};

var RTCSTATUS = { 
	IDLE : "idle",
	CONNECTED	: "connected",
};


function rtcSetConnection() {
				var role = ROLE.CALLER;
				var rtcstatus = RTCSTATUS.IDLE;

				var lPC = undefined;
				var sendChannel = undefined;
				
				// called on either createOffer or createAnswer
				function localDescriptionCallback(sdp) { 
								console.log("we got local description", sdp);
								lPC.setLocalDescription(sdp, 
									function () { 
										smsPostMessage("sdp", JSON.stringify(sdp)); // success, we post our description

									},
										function (error) { console.log("ERR: setLocalDescription ", error) } // errorCallback
				)}

        var iceServers = {
            iceServers: [
						{ url: 'stun:stun.sipgate.net' },
						{ url: 'stun:stun.ekiga.net' },
						{ url: 'stun:stun.l.google.com:19302' },
						]
        };

        if (window.RTCPeerConnection != undefined )
                RPCObject =  window.RTCPeerConnection
        else if (window.mozRTCPeerConnection != undefined )
                RPCObject =  window.mozRTCPeerConnection
        else if (window.webkitRTCPeerConnection != undefined )
                RPCObject =  window.webkitRTCPeerConnection
        else throw "Error finding RPCObject";

        lPC = new RPCObject(iceServers, {optional: [{RtpDataChannels: true}]});


        lPC.onicecandidate = function(evt) {
//						console.log("0: got ice candidate", evt.candidate);
            smsPostMessage("candidate", JSON.stringify(evt.candidate));
        }

        lPC.onconnecting = function(evt) {
            console.log("2: !" , evt);
        }

        lPC.onopen = function(evt) {
            console.log("3: !" , evt);
        }

        lPC.ondatachannel = function(evt) {
            console.log("4: !" , evt);
        }

        lPC.oniceconnectionstatechange = function(evt) {
            console.log("5: !" , evt);
						console.log("Ice connection state: ", lPC.iceConnectionState);
        }

        lPC.onnegotiationneeded = function(evt) {
            console.log("onnegotiationneded: !", evt);
					  lPC.createOffer( localDescriptionCallback, console.log);
				}

        lPC.onsignalingstatechange = function(evt) {
            console.log("signalstatechange: !" , evt);
        }

        lPC.onaddstream = function(evt) {
            console.log("remoteaddedstream: !" , evt);
        }

        lPC.onremovestream = function(evt) {
            console.log("remoteremovedstream: !" , evt);
        }
        console.log("created lpc ", lPC);

        sendChannel = lPC.createDataChannel("data1", {});
        sendChannel.onopen = function(evt) {
            console.log("sC: 1" , evt);
        }

				smsRegisterCallback("candidate", function(message) {
						msg = JSON.parse(message);
						console.log("got remote candidate", msg);
						lPC.addIceCandidate(new RTCIceCandidate(msg));
				});

				smsRegisterCallback("sdp", function(message) {
						msg = JSON.parse(message);
						console.log("got remote offer", msg);
						lPC.setRemoteDescription(new RTCSessionDescription(msg), 
								function () {
									lPC.createAnswer( localDescriptionCallback, console.log );
								}
							, console.log); // we got another peer's offer
				});

		return lPC;
}


</script>

<script>
/**
	Start the system when the page is loaded.
*/
$(document).ready( function () {
	smsStartSystem();	

	// for each client already existing, we will createOffers and send them
	peerConns = [];
  smsListClients(function (clients) {
		console.log(clients);
		for (i = 0; i < clients.length; i++) {
				if (clients[i].s != myId) {
							console.log("SETUP: trying to connect to ", clients[i].s);
//							peerConns.push(rtcSetConnection());
				}
		}
	});

	// then we wait for new clients waiting to join us
	console.log("waiting for remote");
//	rtcSetConnection();	

});

window.onbeforeunload = function () {
	console.log("almost dead");
	smsStopSystem();
};

</script>

<div id="list1"></div>
<script>
</script>
</body>
</html>
