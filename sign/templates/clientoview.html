{%extends "home.html"%}
<!-- vim: set tabstop=2 expandtab ai: -->
{% load staticfiles %}


{%block "mainbody"%}
<script src="{% static "js/appcommon.js" %}"></script>
<script>
  var logviewApp = angular.module('logview', ['ui.bootstrap'], angular_formpost);
  logviewApp.config(function($interpolateProvider) {
    $interpolateProvider.startSymbol("{[");
    $interpolateProvider.endSymbol("]}");
  });

  logviewApp.controller('appCtrl', function($scope, $http, $q, $interval) {

    $scope.clientset = [
    {% for i in clients %}
      { "externid" : "{{i.externid}}", "clientlog_count":{{i.clientlog_set.all|length}},
        "ip" : "{{i.ip}}", "useragent" : "{{i.useragent}}", "updated": "{{i.updated}}" },
    {% endfor %}
    ];
    $scope.logset = [];

    $scope._clientInClientSet = function(id) {
        var i = 0;
        for (i = 0; i < $scope.clientset.length; i++)
        {
            if ($scope.clientset[i].externid == id) {
                return $scope.clientset[i];
            }
        }
    }

    $scope.logUpdate = function() {
      if ($scope.clientid === null) 
        return;
      var client = $scope._clientInClientSet($scope.clientid);
      $scope.useragent = client.useragent;
      $scope.ip = client.ip;
      $scope.updated = client.updated;

      $http.get("/log?" + $.param({t: $scope.clientid}))
        .success(
          function (data) {
            $scope.logset = data;
          }
        )
        .error(
          function (data, status) {
              alert("Failed log retrieval call " + status);
          }
        );
    }

    $scope.clientUpdate = function() {
      $http.get("/log?" + $.param({"type" : "client"}))
        .success(
          function (data) {
            $scope.clientset = data;
          }
        )
        .error(
          function (data, status) {
            alert("Failed client retrieval call " + status);
//            $interval.cancel($scope.updateInterval); 
          }
        );
    }

//    $scope.updateInterval = $interval( $scope.clientUpdate, 2000);
  });

 
</script>

<div id="main" role="main" ng-app="logview" ng-controller="appCtrl" class="container">
    

    <div class="row">
      <div class="col-md-12">
        <table class="table">
          {% for c in channels %}
          <tr> <td> Name: {{c.name}} <hr/>Owner:
            <table class="table">
              <tr><td>ID</td><td>{{c.master.id}}</td></tr>
              <tr><td>UserAgent</td><td>{{c.master.useragent}}</td></tr>
              <tr><td>IP</td><td>{{c.master.ip}}</td></tr>
              <tr><td>Last Seen:</td><td>{{c.master.updated}}</td></tr>
            </table>
              </td> <td>
            Viewers: <hr/>
            {% for cr in c.channelrelay_set.all|dictsort:"id" %} 
            <table class="table">
              <tr><td>ID</td><td>{{cr.client.id}}</td></tr>
              <tr><td>UserAgent</td><td>{{cr.client.useragent}}</td></tr>
              <tr><td>IP</td><td>{{cr.client.ip}}</td></tr>
              <tr><td>Last Seen:</td><td>{{cr.client.updated}} ( status: {{cr.client.status}} )</td></tr>
            </table></br>
            </td></tr>
            {% endfor %}
          {% endfor %}
        </table>
      </div>
    </div>
{%endblock%}
